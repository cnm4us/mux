# Side-by-side path-scoped build blocks for /b/BUILD_ID/
#
# Include these in addition to your existing root config to serve a new isolated build
# without changing the root. Useful for DEV A/B checks.

# Long-cache for hashed assets
location ^~ /b/BUILD_ID/assets/ {
  alias /var/www/mux-spa-builds/BUILD_ID/assets/;
  add_header Cache-Control "public, max-age=31536000, immutable" always;
  expires 1y;
  try_files $uri =404;
}

# App icons (short/no cache)
location ^~ /b/BUILD_ID/icons/ {
  alias /var/www/mux-spa-builds/BUILD_ID/icons/;
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
  try_files $uri =404;
}

# No-store for app shell and metadata
location = /b/BUILD_ID/index.html {
  alias /var/www/mux-spa-builds/BUILD_ID/index.html;
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
}

location = /b/BUILD_ID/sw.js {
  alias /var/www/mux-spa-builds/BUILD_ID/sw.js;
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
}

location = /b/BUILD_ID/version.json {
  alias /var/www/mux-spa-builds/BUILD_ID/version.json;
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
}

location ~* ^/b/BUILD_ID/(manifest\.webmanifest|manifest\.json)$ {
  alias /var/www/mux-spa-builds/BUILD_ID/;
  add_header Cache-Control "no-cache, no-store, must-revalidate" always;
  add_header Pragma "no-cache" always;
  add_header Expires "0" always;
  try_files $uri =404;
}

# SPA scope root: serve files and fallback to index.html
location ^~ /b/BUILD_ID/ {
  alias /var/www/mux-spa-builds/BUILD_ID/;
  try_files $uri $uri/ /index.html;
}
