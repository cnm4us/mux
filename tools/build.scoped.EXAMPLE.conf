# Example: path-scoped build conf for /b/BUILD_ID/
#
# Copy to:   /etc/nginx/mux/builds/BUILD_ID.conf
# Symlink as: /etc/nginx/mux/build.current.conf â†’ /etc/nginx/mux/builds/BUILD_ID.conf
# Build dir:  /var/www/mux-spa-builds/BUILD_ID/ (Vite build with base=/b/BUILD_ID/)

# Redirect root to the current build path (atomic switch via symlink)
location = / {
  return 302 /b/BUILD_ID/;
}

# Serve the versioned build under its own scope
location ^~ /b/BUILD_ID/ {
  alias /var/www/mux-spa-builds/BUILD_ID/;

  # Long-cache for hashed assets
  location ^~ /b/BUILD_ID/assets/ {
    alias /var/www/mux-spa-builds/BUILD_ID/assets/;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    expires 1y;
    try_files $uri =404;
  }

  # No-store for app shell and metadata
  location = /b/BUILD_ID/index.html {
    alias /var/www/mux-spa-builds/BUILD_ID/index.html;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files /b/BUILD_ID/index.html =404;
  }

  location = /b/BUILD_ID/sw.js {
    alias /var/www/mux-spa-builds/BUILD_ID/sw.js;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files /b/BUILD_ID/sw.js =404;
  }

  location = /b/BUILD_ID/version.json {
    alias /var/www/mux-spa-builds/BUILD_ID/version.json;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files /b/BUILD_ID/version.json =404;
  }

  location ~* ^/b/BUILD_ID/(manifest\.webmanifest|manifest\.json)$ {
    alias /var/www/mux-spa-builds/BUILD_ID/$1;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files $uri =404;
  }

  # App icons (short/no cache)
  location ^~ /b/BUILD_ID/icons/ {
    alias /var/www/mux-spa-builds/BUILD_ID/icons/;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files $uri =404;
  }

  # History fallback within this scope
  try_files $uri $uri/ /b/BUILD_ID/index.html;
}

